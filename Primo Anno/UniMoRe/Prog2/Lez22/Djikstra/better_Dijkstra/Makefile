# Makefile per l'algoritmo di Dijkstra migliorato
# Versione con std::priority_queue, gestione errori e programmazione OOP

# Compilatore e flags
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -g

# Directory e file
GRAFO_DIR = ../../../Lez20/grafo
CURRENT_DIR = .

# File sorgente
SOURCES = main.cc better_dijkstra.cc $(GRAFO_DIR)/grafo.cc
HEADERS = better_dijkstra.h $(GRAFO_DIR)/grafo.h

# File oggetto
OBJECTS = main.o better_dijkstra.o grafo.o

# Target principale
TARGET = better_dijkstra

# Include directory
INCLUDES = -I$(GRAFO_DIR)

# ==============================================================================
# REGOLE DI COMPILAZIONE
# ==============================================================================

# Regola principale: compila il programma
all: $(TARGET)
	@echo "âœ… Compilazione completata!"
	@echo "ğŸš€ Usa: ./$(TARGET) [file_grafo]"

# Linking dell'eseguibile
$(TARGET): $(OBJECTS)
	@echo "ğŸ”— Linking $(TARGET)..."
	$(CXX) $(CXXFLAGS) -o $@ $^

# Compilazione file main
main.o: main.cc better_dijkstra.h
	@echo "ğŸ”§ Compilando main.cc..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c main.cc

# Compilazione implementazione Dijkstra migliorata  
better_dijkstra.o: better_dijkstra.cc better_dijkstra.h
	@echo "ğŸ”§ Compilando better_dijkstra.cc..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c better_dijkstra.cc

# Compilazione modulo grafo
grafo.o: $(GRAFO_DIR)/grafo.cc $(GRAFO_DIR)/grafo.h
	@echo "ğŸ”§ Compilando grafo.cc..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $(GRAFO_DIR)/grafo.cc

# ==============================================================================
# REGOLE DI PULIZIA
# ==============================================================================

# Pulizia file oggetto
clean:
	@echo "ğŸ§¹ Pulizia file oggetto..."
	rm -f $(OBJECTS)

# Pulizia completa
distclean: clean
	@echo "ğŸ§¹ Pulizia completa..."
	rm -f $(TARGET)

# ==============================================================================
# REGOLE DI TEST E ESECUZIONE
# ==============================================================================

# Test con file di esempio
test: $(TARGET)
	@echo "ğŸ§ª Esecuzione test con graph1.w..."
	./$(TARGET) ../file-grafo/graph1.w

# Test interattivo
test-interactive: $(TARGET)
	@echo "ğŸ® Test interattivo - inserisci tu il nodo sorgente:"
	./$(TARGET)

# ==============================================================================
# REGOLE DI DOCUMENTAZIONE
# ==============================================================================

# Genera documentazione Doxygen
docs:
	@echo "ğŸ“š Generazione documentazione..."
	@if [ -f "Doxyfile" ]; then \
		doxygen Doxyfile; \
		echo "âœ… Documentazione generata in docs/html/"; \
	else \
		echo "âŒ File Doxyfile non trovato!"; \
	fi

# ==============================================================================
# REGOLE DI DEBUG E ANALISI
# ==============================================================================

# Compilazione per debug
debug: CXXFLAGS += -DDEBUG -O0
debug: $(TARGET)
	@echo "ğŸ› Versione debug compilata"

# Analisi con Valgrind (se disponibile)
valgrind: $(TARGET)
	@echo "ğŸ” Analisi memoria con Valgrind..."
	@if command -v valgrind >/dev/null 2>&1; then \
		valgrind --leak-check=full --show-leak-kinds=all ./$(TARGET) ../file-grafo/graph1.w; \
	else \
		echo "âŒ Valgrind non disponibile"; \
	fi

# ==============================================================================
# INFORMAZIONI E AIUTO
# ==============================================================================

# Mostra informazioni sui miglioramenti
info:
	@echo "ğŸ“Š MIGLIORAMENTI IMPLEMENTATI:"
	@echo "1. ğŸ“Š std::priority_queue invece di lista custom"
	@echo "2. ğŸ§¹ Gestione automatica memoria (RAII)"  
	@echo "3. ğŸš¦ Gestione errori completa"
	@echo "4. ğŸ§© Programmazione OOP (classe DijkstraSolver)"
	@echo "5. ğŸ“ Documentazione Doxygen estesa"
	@echo ""
	@echo "ğŸ¯ VANTAGGI:"
	@echo "   â€¢ ComplessitÃ  migliorata: O((V+E) log V)"
	@echo "   â€¢ Nessun memory leak (RAII)"
	@echo "   â€¢ Codice piÃ¹ robusto e manutenibile"
	@echo "   â€¢ Gestione errori granulare"
	@echo "   â€¢ Interfaccia pulita e riusabile"

# Aiuto comandi disponibili
help:
	@echo "ğŸ› ï¸  COMANDI MAKEFILE DISPONIBILI:"
	@echo ""
	@echo "ğŸ“¦ COMPILAZIONE:"
	@echo "   make          - Compila il programma"
	@echo "   make debug    - Compila versione debug"
	@echo "   make clean    - Rimuove file oggetto"
	@echo "   make distclean- Pulizia completa"
	@echo ""
	@echo "ğŸ§ª TEST:"
	@echo "   make test     - Test automatico con graph1.w"
	@echo "   make test-interactive - Test interattivo"
	@echo "   make valgrind - Analisi memoria"
	@echo ""
	@echo "ğŸ“š DOCUMENTAZIONE:"
	@echo "   make docs     - Genera documentazione Doxygen"
	@echo "   make info     - Mostra miglioramenti implementati"
	@echo "   make help     - Mostra questo aiuto"

# ==============================================================================
# DICHIARAZIONI PHONY
# ==============================================================================

.PHONY: all clean distclean test test-interactive docs debug valgrind info help
